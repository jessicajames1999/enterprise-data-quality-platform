name: Airflow Failure Auto-Fix

on:
  repository_dispatch:
    types: [airflow-failure, test-curl]
  workflow_dispatch:

jobs:
  create-fix-and-update-pagerduty:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract failure data
        id: extract-data
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "PIPELINE_ERROR=Test pipeline failure" >> $GITHUB_ENV
            echo "FAILED_TASK=test_validation" >> $GITHUB_ENV
            echo "INCIDENT_KEY=test-incident-123" >> $GITHUB_ENV
            echo "ERROR_DETAILS={\"test\": \"manual trigger\", \"task\": \"test_validation\"}" >> $GITHUB_ENV
          else
            PAYLOAD=$(echo '${{ toJson(github.event.client_payload) }}' | tr -d '\n')
            echo "Raw payload: $PAYLOAD"
            
            if echo "$PAYLOAD" | jq -e '.pipeline_failure' > /dev/null; then
              echo "PIPELINE_ERROR=$(echo "$PAYLOAD" | jq -r '.pipeline_failure.error')" >> $GITHUB_ENV
              echo "FAILED_TASK=$(echo "$PAYLOAD" | jq -r '.pipeline_failure.task')" >> $GITHUB_ENV
              echo "INCIDENT_KEY=$(echo "$PAYLOAD" | jq -r '.pagerduty_incident_key')" >> $GITHUB_ENV
              echo "ERROR_DETAILS=$PAYLOAD" >> $GITHUB_ENV
            else
              echo "PIPELINE_ERROR=Curl test trigger" >> $GITHUB_ENV
              echo "FAILED_TASK=test_curl_validation" >> $GITHUB_ENV
              echo "INCIDENT_KEY=curl-test-123" >> $GITHUB_ENV
              echo "ERROR_DETAILS=$PAYLOAD" >> $GITHUB_ENV
            fi
          fi
          
          echo "Extracted data:"
          echo "PIPELINE_ERROR: $PIPELINE_ERROR"
          echo "FAILED_TASK: $FAILED_TASK"
          echo "INCIDENT_KEY: $INCIDENT_KEY"

      - name: Send to agent for analysis
        id: agent-response
        run: |
          echo "Sending failure data to agent for analysis..."
          
          # Create properly formatted payload using jq
          PAYLOAD=$(jq -n \
            --arg agent_name "${{ secrets.AGENT_ID }}" \
            --argjson content "$ERROR_DETAILS" \
            --arg created_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '{
              "agent_name": $agent_name,
              "input": [
                {
                  "parts": [
                    {
                      "content_type": "application/json",
                      "content": $content
                    }
                  ],
                  "created_at": $created_at
                }
              ]
            }')
          
          echo "Payload created, sending to agent..."
          
          AGENT_RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.AGENT_API_KEY }}" \
            -d "$PAYLOAD" \
            "${{ vars.AGENT_API_ENDPOINT }}" || echo '{"error": "Agent request failed"}')
          
          echo "Agent response: $AGENT_RESPONSE"
          
          RUN_ID=$(echo "$AGENT_RESPONSE" | jq -r '.run_id')
          
          if [ "$RUN_ID" != "null" ] && [ -n "$RUN_ID" ]; then
            echo "Waiting for agent run $RUN_ID to complete..."
            for i in {1..30}; do
              sleep 10
              STATUS_RESPONSE=$(curl -s -X GET \
                -H "Authorization: Bearer ${{ secrets.AGENT_API_KEY }}" \
                "${{ vars.AGENT_API_ENDPOINT }}/$RUN_ID")
              
              STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.status')
              if [ "$STATUS" = "completed" ]; then
                ANALYSIS=$(echo "$STATUS_RESPONSE" | jq -r '.output[0].parts[0].content')
                break
              elif [ "$STATUS" = "failed" ]; then
                ANALYSIS="Agent run failed"
                break
              fi
            done
          else
            ANALYSIS="Failed to start agent run"
          fi
          
          cat << 'ANALYSIS_EOF' > analysis.md
          # Airflow Pipeline Failure Analysis

          ## Issue Summary
          ANALYSIS_EOF
          echo "**Pipeline Error:** $PIPELINE_ERROR" >> analysis.md
          echo "**Failed Task:** $FAILED_TASK" >> analysis.md
          echo "**PagerDuty Incident:** $INCIDENT_KEY" >> analysis.md
          echo "" >> analysis.md
          echo "## AI Agent Analysis" >> analysis.md
          echo "$ANALYSIS" >> analysis.md
          echo "" >> analysis.md
          echo "## Recommended Actions" >> analysis.md
          echo "Based on the analysis above, please review the proposed changes and merge if appropriate." >> analysis.md
          echo "" >> analysis.md
          echo "Generated automatically by GitHub Actions workflow." >> analysis.md
          
          echo "analysis-ready=true" >> $GITHUB_OUTPUT

      - name: Create PR with fix
        if: steps.agent-response.outputs.analysis-ready == 'true'
        run: |
          git config --local user.email "airflow-bot@company.com"
          git config --local user.name "Airflow Fix Bot"
          
          BRANCH_NAME="fix/airflow-failure-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          
          git add analysis.md
          git commit -m "Auto-fix for Airflow failure: $FAILED_TASK"
          
          git push origin "$BRANCH_NAME"
          
          PR_BODY="**Airflow Pipeline Failure Auto-Fix**

          **Failed Task:** $FAILED_TASK
          **Error:** $PIPELINE_ERROR
          **PagerDuty Incident:** $INCIDENT_KEY

          **AI Agent Analysis:**
          $(cat analysis.md)

          <!-- PAGERDUTY_INCIDENT_KEY: $INCIDENT_KEY -->

          This PR was automatically generated in response to an Airflow pipeline failure."
          
          PR_URL=$(gh pr create \
            --title "Auto-fix: $FAILED_TASK Pipeline Failure" \
            --body "$PR_BODY" \
            --head "$BRANCH_NAME" \
            --base main \
            --label "airflow-failure,auto-fix,pagerduty:$INCIDENT_KEY" \
            --output json | jq -r '.url')
          
          echo "PR created: $PR_URL"
          echo "PR_URL=$PR_URL" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update PagerDuty incident
        if: env.INCIDENT_KEY != 'test-incident-123' && env.INCIDENT_KEY != 'curl-test-123'
        run: |
          echo "Updating PagerDuty incident with PR link..."
          
          curl -s -X POST \
            "https://events.pagerduty.com/generic/2010-04-15/create_event.json" \
            -H "Content-Type: application/json" \
            -d "{
              \"service_key\": \"${{ vars.PAGERDUTY_SERVICE_KEY }}\",
              \"incident_key\": \"$INCIDENT_KEY\",
              \"event_type\": \"resolve\",
              \"description\": \"Auto-fix PR created: $PR_URL\",
              \"details\": {
                \"pr_url\": \"$PR_URL\",
                \"status\": \"auto_fix_generated\",
                \"agent_analysis\": \"Analysis complete - see PR for details\"
              }
            }"
          
          echo "PagerDuty incident updated and resolved"