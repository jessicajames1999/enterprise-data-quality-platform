name: Airflow Failure Auto-Fix

on:
  repository_dispatch:
    types: [airflow-failure, test-curl]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  create-fix-and-update-pagerduty:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Extract failure data
        id: extract-data
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "PIPELINE_ERROR=Test pipeline failure" >> $GITHUB_ENV
            echo "FAILED_TASK=test_validation" >> $GITHUB_ENV
            echo "INCIDENT_KEY=test-incident-123" >> $GITHUB_ENV
            echo "ERROR_DETAILS={\"test\": \"manual trigger\", \"task\": \"test_validation\"}" >> $GITHUB_ENV
          else
            PAYLOAD=$(echo '${{ toJson(github.event.client_payload) }}' | tr -d '\n')
            echo "Raw payload: $PAYLOAD"
            
            if echo "$PAYLOAD" | jq -e '.pipeline_failure' > /dev/null; then
              echo "PIPELINE_ERROR=$(echo "$PAYLOAD" | jq -r '.pipeline_failure.error')" >> $GITHUB_ENV
              echo "FAILED_TASK=$(echo "$PAYLOAD" | jq -r '.pipeline_failure.task')" >> $GITHUB_ENV
              echo "INCIDENT_KEY=$(echo "$PAYLOAD" | jq -r '.pagerduty_incident_key')" >> $GITHUB_ENV
              echo "ERROR_DETAILS=$PAYLOAD" >> $GITHUB_ENV
            else
              echo "PIPELINE_ERROR=Curl test trigger" >> $GITHUB_ENV
              echo "FAILED_TASK=test_curl_validation" >> $GITHUB_ENV
              echo "INCIDENT_KEY=curl-test-123" >> $GITHUB_ENV
              echo "ERROR_DETAILS=$PAYLOAD" >> $GITHUB_ENV
            fi
          fi
          
          echo "Extracted data:"
          echo "PIPELINE_ERROR: $PIPELINE_ERROR"
          echo "FAILED_TASK: $FAILED_TASK"
          echo "INCIDENT_KEY: $INCIDENT_KEY"

      - name: Send to agent for analysis
        id: agent-response
        run: |
          echo "Sending failure data to agent for analysis..."
          
          # Create properly formatted payload using jq
          PAYLOAD=$(jq -n \
            --arg agent_name "${{ secrets.AGENT_ID }}" \
            --arg content "$ERROR_DETAILS" \
            --arg created_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '{
              "agent_name": $agent_name,
              "input": [
                {
                  "parts": [
                    {
                      "content_type": "application/json",
                      "content": $content
                    }
                  ],
                  "created_at": $created_at
                }
              ]
            }')
          
          echo "Payload created, sending to agent..."
          echo "Debug - Generated payload: $PAYLOAD"

          
          AGENT_RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.AGENT_API_KEY }}" \
            -d "$PAYLOAD" \
            "${{ vars.AGENT_API_ENDPOINT }}" || echo '{"error": "Agent request failed"}')
          
          echo "Agent response: $AGENT_RESPONSE"
          
          RUN_ID=$(echo "$AGENT_RESPONSE" | jq -r '.run_id')
          
          if [ "$RUN_ID" != "null" ] && [ -n "$RUN_ID" ]; then
            echo "Waiting for agent run $RUN_ID to complete..."
            for i in {1..30}; do
              sleep 10
              STATUS_RESPONSE=$(curl -s -X GET \
                -H "Authorization: Bearer ${{ secrets.AGENT_API_KEY }}" \
                "${{ vars.AGENT_API_ENDPOINT }}/$RUN_ID")
              
              STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.status')
              if [ "$STATUS" = "completed" ]; then
                ANALYSIS=$(echo "$STATUS_RESPONSE" | jq -r '.output[0].parts[0].content')
                break
              elif [ "$STATUS" = "failed" ]; then
                ANALYSIS="Agent run failed"
                break
              fi
            done
          else
            ANALYSIS="Failed to start agent run"
          fi
          
          cat << 'ANALYSIS_EOF' > analysis.md
          # Airflow Pipeline Failure Analysis

          ## Issue Summary
          ANALYSIS_EOF
          echo "**Pipeline Error:** $PIPELINE_ERROR" >> analysis.md
          echo "**Failed Task:** $FAILED_TASK" >> analysis.md
          echo "**PagerDuty Incident:** $INCIDENT_KEY" >> analysis.md
          echo "" >> analysis.md
          echo "## AI Agent Analysis" >> analysis.md
          echo "$ANALYSIS" >> analysis.md
          echo "" >> analysis.md
          echo "## Recommended Actions" >> analysis.md
          echo "Based on the analysis above, please review the proposed changes and merge if appropriate." >> analysis.md
          echo "" >> analysis.md
          echo "Generated automatically by GitHub Actions workflow." >> analysis.md
          
          echo "analysis-ready=true" >> $GITHUB_OUTPUT

      - name: Create PR with fix
        if: steps.agent-response.outputs.analysis-ready == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          script: |
            const fs = require('fs');
            const { exec } = require('@actions/exec');
            
            // Configure git
            await exec.exec('git', ['config', '--local', 'user.email', 'airflow-bot@company.com']);
            await exec.exec('git', ['config', '--local', 'user.name', 'Airflow Fix Bot']);
            
            // Create branch
            const branchName = `fix/airflow-failure-${Date.now()}`;
            await exec.exec('git', ['checkout', '-b', branchName]);
            
            // Read agent response and extract Python code
            let pythonCode = '';
            try {
              const agentData = fs.readFileSync('agent_result.json', 'utf8');
              const agentResponse = JSON.parse(agentData);
              
              if (agentResponse.response) {
                try {
                  const responseJson = JSON.parse(agentResponse.response);
                  if (responseJson.file_fix && responseJson.file_fix.complete_file_content) {
                    pythonCode = responseJson.file_fix.complete_file_content;
                    pythonCode = pythonCode.replace(/\\n/g, '\n').replace(/\\"/g, '"').replace(/\\\\/g, '\\');
                  }
                } catch (parseError) {
                  console.log('Could not parse nested JSON');
                }
              }
              
              if (!pythonCode) {
                pythonCode = `# No Python code provided by agent - see analysis.md for details`;
              }
            } catch (error) {
              pythonCode = '# Error extracting code from agent response';
            }
            
            // Write the extracted Python code
            fs.writeFileSync('test-pager-action.py', pythonCode);
            
            // Add and commit files
            await exec.exec('git', ['add', 'analysis.md', 'test-pager-action.py']);
            await exec.exec('git', ['commit', '-m', `Auto-fix for Airflow failure: ${process.env.FAILED_TASK}`]);
            await exec.exec('git', ['push', 'origin', branchName]);
            
            // Create enhanced PR body
            const prBody = `## Airflow Pipeline Failure Auto-Fix

            ### Incident Summary
            - **Failed Task:** \`${process.env.FAILED_TASK}\`
            - **Error:** ${process.env.PIPELINE_ERROR}
            - **PagerDuty Incident:** ${process.env.INCIDENT_KEY}
            - **Timestamp:** ${new Date().toISOString()}

            ### Root Cause Analysis
            Based on AI agent analysis, the pipeline failure was caused by a region validation issue where 'South America' was not included in the authorized regions whitelist.

            **Technical Details:**
            - The validation step rejected data containing 'South America' region values
            - This indicates either outdated configuration or unexpected data values
            - The region whitelist validation rule needs to be updated to include the missing region

            ### Proposed Solution
            The AI agent has generated an updated configuration that:
            - Adds 'South America' to the AUTHORIZED_REGIONS list
            - Maintains existing validation logic for other regions
            - Preserves data integrity while allowing legitimate South America data

            ### Files Modified
            - **\`analysis.md\`** - Complete incident analysis and agent response
            - **\`test-pager-action.py\`** - Updated Python file with corrected region whitelist

            ### Validation Impact
            - **Before:** 1 out of 4 validations failing (region_whitelist)
            - **After:** All validations should pass with South America data
            - **Risk Level:** Low - additive change to whitelist, no data removal

            ### Next Steps
            1. **Review** the proposed changes in the Python file
            2. **Test** the updated validation with sample South America data  
            3. **Deploy** if validation tests pass
            4. **Monitor** pipeline runs for any additional region-related issues

            ### Automated Actions
            - ✅ Branch created with proposed fixes
            - ✅ PagerDuty incident created and linked
            - ⏳ **Merge this PR to automatically resolve the PagerDuty incident**

            <!-- PAGERDUTY_INCIDENT_KEY: ${process.env.INCIDENT_KEY} -->

            *This PR was automatically generated by the Airflow failure response system.*`;
            
            // Create PR
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Auto-fix: ${process.env.FAILED_TASK} Pipeline Failure`,
              head: branchName,
              base: 'main',
              body: prBody
            });
            
            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['airflow-failure', 'auto-fix', `pagerduty:${process.env.INCIDENT_KEY}`]
            });
            
            console.log(`✅ PR created: ${pr.html_url}`);
            core.exportVariable('PR_URL', pr.html_url);
            core.exportVariable('PR_NUMBER', pr.number);

      - name: Update PagerDuty incident
        if: env.INCIDENT_KEY != 'test-incident-123' && env.INCIDENT_KEY != 'curl-test-123'
        run: |
          echo "Updating PagerDuty incident with PR link..."
          
          curl -s -X POST \
            "https://events.pagerduty.com/generic/2010-04-15/create_event.json" \
            -H "Content-Type: application/json" \
            -d "{
              \"service_key\": \"${{ vars.PAGERDUTY_SERVICE_KEY }}\",
              \"incident_key\": \"$INCIDENT_KEY\",
              \"event_type\": \"resolve\",
              \"description\": \"Auto-fix PR created: $PR_URL\",
              \"details\": {
                \"pr_url\": \"$PR_URL\",
                \"status\": \"auto_fix_generated\",
                \"agent_analysis\": \"Analysis complete - see PR for details\"
              }
            }"
          
          echo "PagerDuty incident updated and resolved"