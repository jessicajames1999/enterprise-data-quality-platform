name: Airflow Failure Auto-Fix

on:
  repository_dispatch:
    types: [airflow-failure, test-curl]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  create-fix-and-update-pagerduty:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Extract failure data
        id: extract-data
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "PIPELINE_ERROR=Test pipeline failure" >> $GITHUB_ENV
            echo "FAILED_TASK=test_validation" >> $GITHUB_ENV
            echo "INCIDENT_KEY=test-incident-123" >> $GITHUB_ENV
            echo "ERROR_DETAILS={\"test\": \"manual trigger\", \"task\": \"test_validation\"}" >> $GITHUB_ENV
          else
            PAYLOAD=$(echo '${{ toJson(github.event.client_payload) }}' | tr -d '\n')
            echo "Raw payload: $PAYLOAD"
            
            if echo "$PAYLOAD" | jq -e '.pipeline_failure' > /dev/null; then
              echo "PIPELINE_ERROR=$(echo "$PAYLOAD" | jq -r '.pipeline_failure.error')" >> $GITHUB_ENV
              echo "FAILED_TASK=$(echo "$PAYLOAD" | jq -r '.pipeline_failure.task')" >> $GITHUB_ENV
              echo "INCIDENT_KEY=$(echo "$PAYLOAD" | jq -r '.pagerduty_incident_key')" >> $GITHUB_ENV
              echo "ERROR_DETAILS=$PAYLOAD" >> $GITHUB_ENV
            else
              echo "PIPELINE_ERROR=Curl test trigger" >> $GITHUB_ENV
              echo "FAILED_TASK=test_curl_validation" >> $GITHUB_ENV
              echo "INCIDENT_KEY=curl-test-123" >> $GITHUB_ENV
              echo "ERROR_DETAILS=$PAYLOAD" >> $GITHUB_ENV
            fi
          fi
          
          echo "Extracted data:"
          echo "PIPELINE_ERROR: $PIPELINE_ERROR"
          echo "FAILED_TASK: $FAILED_TASK"
          echo "INCIDENT_KEY: $INCIDENT_KEY"

      - name: Send to agent for analysis
        id: agent-response
        run: |
          echo "Sending failure data to agent for analysis..."
          
          # Create properly formatted payload using jq
          PAYLOAD=$(jq -n \
            --arg agent_name "${{ secrets.AGENT_ID }}" \
            --arg content "$ERROR_DETAILS" \
            --arg created_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '{
              "agent_name": $agent_name,
              "input": [
                {
                  "parts": [
                    {
                      "content_type": "application/json",
                      "content": $content
                    }
                  ],
                  "created_at": $created_at
                }
              ]
            }')
          
          echo "Payload created, sending to agent..."
          echo "Debug - Generated payload: $PAYLOAD"

          
          AGENT_RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.AGENT_API_KEY }}" \
            -d "$PAYLOAD" \
            "${{ vars.AGENT_API_ENDPOINT }}" || echo '{"error": "Agent request failed"}')
          
          echo "Agent response: $AGENT_RESPONSE"
          
          RUN_ID=$(echo "$AGENT_RESPONSE" | jq -r '.run_id')
          
          if [ "$RUN_ID" != "null" ] && [ -n "$RUN_ID" ]; then
            echo "Waiting for agent run $RUN_ID to complete..."
            for i in {1..30}; do
              sleep 10
              STATUS_RESPONSE=$(curl -s -X GET \
                -H "Authorization: Bearer ${{ secrets.AGENT_API_KEY }}" \
                "${{ vars.AGENT_API_ENDPOINT }}/$RUN_ID")
              
              STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.status')
              if [ "$STATUS" = "completed" ]; then
                ANALYSIS=$(echo "$STATUS_RESPONSE" | jq -r '.output[0].parts[0].content')
                echo "$ANALYSIS" > agent_result.json
                break
              elif [ "$STATUS" = "failed" ]; then
                ANALYSIS="Agent run failed"
                echo "$ANALYSIS" > agent_result.json
                break
              fi
            done
          else
            ANALYSIS="Failed to start agent run"
            echo "$ANALYSIS" > agent_result.json
          fi
          
          cat << 'ANALYSIS_EOF' > analysis.md
          # Airflow Pipeline Failure Analysis

          ## Issue Summary
          ANALYSIS_EOF
          echo "**Pipeline Error:** $PIPELINE_ERROR" >> analysis.md
          echo "**Failed Task:** $FAILED_TASK" >> analysis.md
          echo "**PagerDuty Incident:** $INCIDENT_KEY" >> analysis.md
          echo "" >> analysis.md
          echo "## AI Agent Analysis" >> analysis.md
          echo "$ANALYSIS" >> analysis.md
          echo "" >> analysis.md
          echo "## Recommended Actions" >> analysis.md
          echo "Based on the analysis above, please review the proposed changes and merge if appropriate." >> analysis.md
          echo "" >> analysis.md
          echo "Generated automatically by GitHub Actions workflow." >> analysis.md
          
          echo "analysis-ready=true" >> $GITHUB_OUTPUT

      - name: Process agent analysis results  
        id: process-analysis
        run: |
          echo "Processing agent results"
          
          # Validate JSON input
          if ! jq empty agent_result.json 2>/dev/null; then
            echo "Invalid JSON response from agent"
            ROOT_CAUSE="Agent response parsing failed"
            TECHNICAL_DETAILS="Unable to parse technical details"
            FILENAME="Unknown"
            CHANGES_MADE="Unable to parse changes"
          else
            # Extract the response field 
            if jq -e '.response' agent_result.json >/dev/null 2>&1; then
              jq -r '.response' agent_result.json > response_content.txt
            else
              jq -r '.' agent_result.json > response_content.txt
            fi
            
            # Check if response contains markdown code blocks
            if grep -q '```json' response_content.txt; then
              # Extract JSON content between ```json and ``` markers
              sed -n '/```json/,/```/p' response_content.txt | sed '1d;$d' > cleaned_agent_result.json
            else
              cp response_content.txt cleaned_agent_result.json
            fi
            
            # Extract analysis fields from your Airflow agent structure
            if jq empty cleaned_agent_result.json 2>/dev/null; then
              ROOT_CAUSE=$(jq -r '.root_cause_analysis.primary_issue // "Analysis not available"' cleaned_agent_result.json 2>/dev/null || echo "Analysis not available")
              TECHNICAL_DETAILS=$(jq -r '.root_cause_analysis.technical_details // "Technical details not available"' cleaned_agent_result.json 2>/dev/null || echo "Technical details not available")
              FILENAME=$(jq -r '.file_fix.filename // "No file provided"' cleaned_agent_result.json 2>/dev/null || echo "No file provided")
              CHANGES_MADE=$(jq -r '.file_fix.changes_made // "No changes specified"' cleaned_agent_result.json 2>/dev/null || echo "No changes specified")
            else
              ROOT_CAUSE="Agent response parsing failed"
              TECHNICAL_DETAILS="Unable to parse technical details"
              FILENAME="Unknown"
              CHANGES_MADE="Unable to parse changes"
            fi
          fi
          
          # Store results for PR creation
          echo "ROOT_CAUSE=$ROOT_CAUSE" >> $GITHUB_ENV
          echo "TECHNICAL_DETAILS=$TECHNICAL_DETAILS" >> $GITHUB_ENV
          echo "FILENAME=$FILENAME" >> $GITHUB_ENV
          echo "CHANGES_MADE=$CHANGES_MADE" >> $GITHUB_ENV
          
          echo "Extracted root cause: $ROOT_CAUSE"


      - name: Create PR with fix
        if: steps.agent-response.outputs.analysis-ready == 'true'
        run: |
          git config --local user.email "airflow-bot@company.com"
          git config --local user.name "Airflow Fix Bot"
          
          BRANCH_NAME="fix/airflow-failure-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          
          git add analysis.md
          git commit -m "Auto-fix for Airflow failure: $FAILED_TASK"
          git push origin "$BRANCH_NAME"

          # Add debug output here
          echo "Debug - ROOT_CAUSE: $ROOT_CAUSE"
          echo "Debug - FILENAME: $FILENAME"
          echo "Debug - TECHNICAL_DETAILS: $TECHNICAL_DETAILS"
          echo "Debug - CHANGES_MADE: $CHANGES_MADE"
          
          # Use the environment variables set by the processing step
          PR_BODY="## Airflow Pipeline Failure Auto-Fix

          **Failed Task:** $FAILED_TASK
          **Error:** $PIPELINE_ERROR
          **PagerDuty Incident:** $INCIDENT_KEY

          ### Root Cause Analysis
          $ROOT_CAUSE

          **Technical Details:**
          $TECHNICAL_DETAILS

          ### Proposed Fix
          **File:** $FILENAME
          **Changes:** $CHANGES_MADE

          ### Files Modified
          - **analysis.md** - Complete incident analysis and agent response

          <!-- PAGERDUTY_INCIDENT_KEY: $INCIDENT_KEY -->

          This PR was automatically generated in response to an Airflow pipeline failure."
          
          gh pr create \
            --title "Auto-fix: $FAILED_TASK Pipeline Failure" \
            --body "$PR_BODY" \
            --head "$BRANCH_NAME" \
            --base main \
            --label "airflow-failure,auto-fix"
          
          PR_URL="https://github.com/jessicajames1999/enterprise-data-quality-platform/pull/$(gh pr list --head "$BRANCH_NAME" --json number -q '.[0].number')"
          echo "PR_URL=$PR_URL" >> $GITHUB_ENV
          echo "PR created: $PR_URL"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Update PagerDuty incident
        if: env.INCIDENT_KEY != 'test-incident-123' && env.INCIDENT_KEY != 'curl-test-123'
        run: |
          echo "Updating PagerDuty incident with PR link..."
          
          curl -s -X POST \
            "https://events.pagerduty.com/generic/2010-04-15/create_event.json" \
            -H "Content-Type: application/json" \
            -d "{
              \"service_key\": \"${{ vars.PAGERDUTY_SERVICE_KEY }}\",
              \"incident_key\": \"$INCIDENT_KEY\",
              \"event_type\": \"resolve\",
              \"description\": \"Auto-fix PR created: $PR_URL\",
              \"details\": {
                \"pr_url\": \"$PR_URL\",
                \"status\": \"auto_fix_generated\",
                \"agent_analysis\": \"Analysis complete - see PR for details\"
              }
            }"
          
          echo "PagerDuty incident updated and resolved"