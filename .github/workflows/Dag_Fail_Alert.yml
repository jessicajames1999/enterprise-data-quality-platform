# Step 3: Send ticket data to agent and get response
- name: Call agent for analysis
  id: agent-analysis
  run: |
    echo "Sending ticket to agent for analysis"
    
    # Create ticket data JSON
    TICKET_DATA=$(jq -n \
      --arg ticket_id "$TICKET_ID" \
      --arg summary "$SUMMARY" \
      --arg description "$DESCRIPTION" \
      --arg reporter "$REPORTER" \
      --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
      '{
        ticket_id: $ticket_id,
        summary: $summary,
        description: $description,
        reporter: $reporter,
        timestamp: $timestamp
      }')
    
    # Send to agent API
    AGENT_RESPONSE=$(curl -s -X POST \
      -H "Content-Type: application/json" \
      -H "Authorization: Bearer $CHICORY_TOKEN" \
      -d "{
        \"agent_name\": \"$CHICORY_AGENT_ID\",
        \"input\": [{
          \"parts\": [{
            \"content_type\": \"application/json\",
            \"content\": $(echo "$TICKET_DATA" | jq -c .)
          }],
          \"created_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
        }]
      }" \
      https://app.chicory.ai/api/v1/runs)
    
    echo "Agent response: $AGENT_RESPONSE"
    
    # Extract run ID
    RUN_ID=$(echo "$AGENT_RESPONSE" | jq -r '.run_id')
    
    if [ "$RUN_ID" = "null" ] || [ -z "$RUN_ID" ]; then
      echo "Failed to create agent run"
      exit 1
    fi
    
    echo "Created agent run: $RUN_ID"
    echo "Waiting for completion..."
    
    # Simple polling - check every 10 seconds for up to 5 minutes
    for i in {1..30}; do
      echo "Check $i/30"
      
      STATUS_RESPONSE=$(curl -s -X GET \
        -H "Authorization: Bearer $CHICORY_TOKEN" \
        https://app.chicory.ai/api/v1/runs/$RUN_ID)
      
      STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.status')
      echo "Status: $STATUS"
      
      if [ "$STATUS" = "completed" ]; then
        echo "Agent completed successfully"
        
        # Extract the agent output
        AGENT_OUTPUT=$(echo "$STATUS_RESPONSE" | jq -r '.output[0].parts[0].content')
        
        # Save raw output
        echo "$AGENT_OUTPUT" > agent_output.txt
        
        # Try to extract JSON if it's wrapped in markdown
        if echo "$AGENT_OUTPUT" | grep -q '```json'; then
          echo "$AGENT_OUTPUT" | sed -n '/```json/,/```/p' | sed '1d;$d' > agent_result.json
        else
          # Assume the output is already JSON
          echo "$AGENT_OUTPUT" > agent_result.json
        fi
        
        # Validate JSON
        if jq empty agent_result.json 2>/dev/null; then
          echo "Valid JSON extracted"
        else
          echo "Invalid JSON, using fallback"
          echo '{"validation_status":"failed","access_decision":"UNKNOWN","error":"Invalid JSON response"}' > agent_result.json
        fi
        
        break
        
      elif [ "$STATUS" = "failed" ] || [ "$STATUS" = "error" ]; then
        echo "Agent run failed"
        exit 1
      else
        sleep 10
      fi
    done
    
    if [ "$STATUS" != "completed" ]; then
      echo "Agent timed out"
      exit 1
    fi

# Step 4: Extract values from agent results  
- name: Process agent results
  id: process-results
  run: |
    echo "Processing agent results"
    
    # Extract fields with fallbacks
    VALIDATION_STATUS=$(jq -r '.validation_status // "unknown"' agent_result.json)
    ACCESS_DECISION=$(jq -r '.access_decision // "UNKNOWN"' agent_result.json)
    SECURITY_NOTES=$(jq -r '.security_notes // "No security notes"' agent_result.json)
    RECOMMENDATIONS=$(jq -r '.recommendations // "No recommendations"' agent_result.json)
    DATASET=$(jq -r '.dataset // "unknown"' agent_result.json)
    COLUMN=$(jq -r '.column // "unknown"' agent_result.json)
    ACCESS_TYPE=$(jq -r '.access_type // "Read"' agent_result.json)
    REASONING=$(jq -r '.reasoning // "No reasoning provided"' agent_result.json)
    
    # Check for Terraform config
    TERRAFORM_CONFIG=$(jq -r '.terraform_config // ""' agent_result.json)
    
    if [ -n "$TERRAFORM_CONFIG" ] && [ "$TERRAFORM_CONFIG" != "null" ]; then
      mkdir -p terraform/bigquery-access
      TERRAFORM_FILE="terraform/bigquery-access/${TICKET_ID}.tf"
      echo "$TERRAFORM_CONFIG" > "$TERRAFORM_FILE"
      echo "HAS_TERRAFORM=true" >> $GITHUB_ENV
      echo "TERRAFORM_FILE=$TERRAFORM_FILE" >> $GITHUB_ENV
    else
      echo "HAS_TERRAFORM=false" >> $GITHUB_ENV
    fi
    
    # Store all variables
    echo "VALIDATION_STATUS=$VALIDATION_STATUS" >> $GITHUB_ENV
    echo "ACCESS_DECISION=$ACCESS_DECISION" >> $GITHUB_ENV
    echo "SECURITY_NOTES=$SECURITY_NOTES" >> $GITHUB_ENV
    echo "RECOMMENDATIONS=$RECOMMENDATIONS" >> $GITHUB_ENV
    echo "DATASET=$DATASET" >> $GITHUB_ENV
    echo "COLUMN=$COLUMN" >> $GITHUB_ENV
    echo "ACCESS_TYPE=$ACCESS_TYPE" >> $GITHUB_ENV
    echo "REASONING=$REASONING" >> $GITHUB_ENV
    
    echo "Extracted: $ACCESS_DECISION for $DATASET.$COLUMN"
