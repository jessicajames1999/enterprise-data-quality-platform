name: PagerDuty Agent PR Creator

on:
  repository_dispatch:
    types: [incident.triggered]
  workflow_dispatch:  # Allows manual triggering

jobs:
  create-fix-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract PagerDuty incident data
        id: extract-incident
        run: |
          # Extract incident details from PagerDuty webhook payload
          INCIDENT_DATA='${{ toJson(github.event.client_payload) }}'
          echo "PagerDuty incident data: $INCIDENT_DATA"
          
          # Extract key fields from the incident (adjust based on actual PagerDuty payload structure)
          INCIDENT_TITLE=$(echo "$INCIDENT_DATA" | jq -r '.incident.title // .title // "Unknown Incident"')
          INCIDENT_DESCRIPTION=$(echo "$INCIDENT_DATA" | jq -r '.incident.description // .description // "No description available"')
          SERVICE_NAME=$(echo "$INCIDENT_DATA" | jq -r '.incident.service.name // .service.name // "Unknown Service"')
          INCIDENT_URL=$(echo "$INCIDENT_DATA" | jq -r '.incident.html_url // .html_url // ""')
          
          # Create structured alert data for the agent
          ALERT_DETAILS=$(jq -n \
            --arg title "$INCIDENT_TITLE" \
            --arg description "$INCIDENT_DESCRIPTION" \
            --arg service "$SERVICE_NAME" \
            --arg url "$INCIDENT_URL" \
            --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '{
              incident_title: $title,
              incident_description: $description,
              service_name: $service,
              incident_url: $url,
              timestamp: $timestamp,
              source: "pagerduty_webhook"
            }')
          
          echo "Formatted alert data: $ALERT_DETAILS"
          
          # Store for next steps
          echo "INCIDENT_TITLE=$INCIDENT_TITLE" >> $GITHUB_ENV
          echo "SERVICE_NAME=$SERVICE_NAME" >> $GITHUB_ENV
          echo "ALERT_DETAILS=$ALERT_DETAILS" >> $GITHUB_ENV

      - name: Send alert to agent and get response
        id: agent-response
        run: |
          echo "Sending alert to agent for analysis"
          
          # Send alert data to agent API
          AGENT_RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.AGENT_API_KEY }}" \
            -d "{
              \"agent_id\": \"${{ secrets.AGENT_ID }}\",
              \"message\": \"$ALERT_DETAILS\",
              \"context\": \"pagerduty_alert\"
            }" \
            "${{ vars.AGENT_API_ENDPOINT }}")
          
          echo "Agent response: $AGENT_RESPONSE"
          
          # Extract the fix content (adjust based on your agent's response format)
          FIX_CONTENT=$(echo "$AGENT_RESPONSE" | jq -r '.response // .message // .content // "No response from agent"')
          
          # Save to file for PR creation
          echo "$FIX_CONTENT" > proposed_fix.md
          
          # Set outputs for next steps
          echo "fix-available=true" >> $GITHUB_OUTPUT

      - name: Create branch and PR
        if: steps.agent-response.outputs.fix-available == 'true'
        run: |
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "PagerDuty Agent Bot"
          
          # Create new branch
          BRANCH_NAME="fix/pagerduty-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          
          # Add the proposed fix
          git add proposed_fix.md
          git commit -m "Auto-fix for PagerDuty incident: $INCIDENT_TITLE

          Service: $SERVICE_NAME
          Generated by PagerDuty webhook automation"
          
          # Push branch
          git push origin "$BRANCH_NAME"
          
          # Create PR using GitHub CLI
          gh pr create \
            --title "ðŸš¨ Auto-fix for PagerDuty Incident: $SERVICE_NAME" \
            --body "**Incident:** $INCIDENT_TITLE

          **Service:** $SERVICE_NAME

          **Agent Analysis & Proposed Fix:**
          $(cat proposed_fix.md)

          **Incident Details:**
          \`\`\`json
          $ALERT_DETAILS
          \`\`\`

          This PR was automatically created in response to a PagerDuty incident." \
            --head "$BRANCH_NAME" \
            --base main \
            --label "pagerduty-alert,automated"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}